<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Diff</title>
	<link rel="stylesheet" href="style.css"/>
	<style>
		body {
			font-family: Arial, sans-serif;
		}
		table {
			width: 100%;
		}
		textarea {
			width: 100%;
			height: 200px;
		}
		pre {
			white-space: pre-wrap;
			word-wrap: break-word;
		}
		ins {
			background: #d4fcbc;
			text-decoration: none;
		}
		del {
			background: #fbb6c2;
			text-decoration: line-through;
		}
		.chunk-header {
			color: #999;
			font-weight: bold;
		}
		.file-upload {
			margin-top: 10px;
			display: flex;
			gap: 20px;
			font-size: 14px;
		}
	</style>
</head>
<body>

<div id="settings">
	<h1>Diff</h1>

	<label><input type="radio" name="diff_type" value="diffChars" checked> Chars</label>
	<label><input type="radio" name="diff_type" value="diffWords"> Words</label>
	<label><input type="radio" name="diff_type" value="diffLines"> Lines</label>
	<label><input type="radio" name="diff_type" value="diffPatch"> Patch</label>

	<div class="file-upload">
		<label>
			Load File A:
			<input type="file" id="fileA" accept=".txt">
		</label>
		<label>
			Load File B:
			<input type="file" id="fileB" accept=".txt">
		</label>
	</div>
</div>

<a href="https://github.com/kpdecker/jsdiff" class="source">github.com/kpdecker/jsdiff</a>

<table>
	<tr>
		<td><textarea id="a">restaurant</textarea></td>
		<td><textarea id="b">aura</textarea></td>
		<td>
			<div>
				<pre id="result"></pre>
			</div>
		</td>
	</tr>
</table>

<!-- jsdiff library -->
<script src="diff.js"></script>

<script>
var a = document.getElementById('a');
var b = document.getElementById('b');
var result = document.getElementById('result');

function changed() {
	var fragment = document.createDocumentFragment();
	var diff;

	if (window.diffType === 'diffPatch') {
		var pastHunkHeader = false;
		diff = Diff.createTwoFilesPatch('a.txt', 'b.txt', a.value, b.value)
			.split('\n')
			.map(function(entry) {
				const obj = { value: entry + '\n' };
				if (entry.startsWith('@@')) {
					obj.chunkHeader = true;
					pastHunkHeader = true;
				} else if (pastHunkHeader) {
					if (entry.startsWith('-')) obj.removed = true;
					else if (entry.startsWith('+')) obj.added = true;
				}
				return obj;
			});
	} else {
		diff = Diff[window.diffType](a.value, b.value);
	}

	for (var i = 0; i < diff.length; i++) {

		if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
			var swap = diff[i];
			diff[i] = diff[i + 1];
			diff[i + 1] = swap;
		}

		var node;
		if (diff[i].removed) {
			node = document.createElement('del');
			node.textContent = diff[i].value;
		} else if (diff[i].added) {
			node = document.createElement('ins');
			node.textContent = diff[i].value;
		} else if (diff[i].chunkHeader) {
			node = document.createElement('span');
			node.className = 'chunk-header';
			node.textContent = diff[i].value;
		} else {
			node = document.createTextNode(diff[i].value);
		}

		fragment.appendChild(node);
	}

	result.textContent = '';
	result.appendChild(fragment);
}

function onDiffTypeChange(radio) {
	window.diffType = radio.value;
	document.title = "Diff " + radio.value.slice(4);
	changed();
}

window.onload = function () {
	onDiffTypeChange(document.querySelector('[name="diff_type"]:checked'));
	changed();
};

a.oninput = b.oninput = changed;

/* ---------- File Upload Logic ---------- */

function loadFile(input, textarea) {
	if (!input.files || !input.files[0]) return;

	const reader = new FileReader();
	reader.onload = function (e) {
		textarea.value = e.target.result;
		changed();
	};
	reader.readAsText(input.files[0]);
}

document.getElementById('fileA').addEventListener('change', function () {
	loadFile(this, a);
});

document.getElementById('fileB').addEventListener('change', function () {
	loadFile(this, b);
});

/* ---------- Radio Change ---------- */

var radios = document.getElementsByName('diff_type');
for (var i = 0; i < radios.length; i++) {
	radios[i].onchange = function (e) {
		onDiffTypeChange(e.target);
	};
}
</script>

</body>
</html>
